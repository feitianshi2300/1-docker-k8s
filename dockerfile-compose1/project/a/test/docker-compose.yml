version: '3.8.2'

  api2-nginx:
    image: ks-nginx
    restart: always
    container_name: test-api2-nginx
    build: ../../../images/openresty
    volumes:
      - ./config/api2/nginx/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf
      - ./config/api2/nginx/vhost:/server/vhost
      - /data/www/api2:/data/www/api2
      - /data/www/ks_webpc:/data/www/ks_webpc
      - /data/www/ks_webh5:/data/www/ks_webh5
      - ./logs/api2/nginx:/server/logs/api2
      - ./logs/api2/nginx:/data/www/api2/storage/logs/
    working_dir: /server/logs/api2
    depends_on:
      - api2-php
    environment:
      TZ: Asia/Shanghai
    command: ["/bin/sh", "-c", "chown -R www.www /data && openresty -g 'daemon off;'"]
    networks:
      - test

  api2-php:
    image: ks-php74-fpm
    container_name: test-api2-php
    restart: always
    build: ../../../images/php/7.4
    volumes:
      - /data/www/api2:/data/www/api2
      - ./config/api2/php/etc/php.ini:/usr/local/etc/php/php.ini
      - ./config/api2/php/php-fpm.d:/usr/local/etc/php-fpm.d
      - ./logs/api2:/server/php/logs/api2
      - ./logs/api2:/data/www/api2/storage/logs/
    working_dir: /server/php/logs/api2
    environment:
      TZ: Asia/Shanghai
    command: sh -c "chown -R www.www /data && php-fpm -c /usr/local/etc/php/php.ini"
    networks:
      - test

networks:
  test:
    driver: bridge
